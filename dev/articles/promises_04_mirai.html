<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Launching tasks with mirai • promises</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Launching tasks with mirai">
<meta name="robots" content="noindex">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">promises</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.3.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Overview</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_01_motivation.html">1. Why use promises?</a></li>
    <li><a class="dropdown-item" href="../articles/promises_02_intro.html">2. An informal intro to async programming</a></li>
    <li><a class="dropdown-item" href="../articles/promises_03_overview.html">3. Working with promises</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Integration</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_04_mirai.html">4. Launching tasks with mirai</a></li>
    <li><a class="dropdown-item" href="../articles/promises_05a_futures.html">5a. Launching tasks with future</a></li>
    <li><a class="dropdown-item" href="../articles/promises_05b_future_promise.html">5b. Advanced future and promises usage</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Usage</h6></li>
    <li><a class="dropdown-item" href="../articles/promises_06_shiny.html">6. Using promises with Shiny</a></li>
    <li><a class="dropdown-item" href="../articles/promises_07_combining.html">7. Combining promises</a></li>
    <li><a class="dropdown-item" href="../articles/promises_08_casestudy.html">8. Case study: Converting a Shiny app to async</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/promises/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Launching tasks with mirai</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/promises/blob/main/vignettes/promises_04_mirai.Rmd" class="external-link"><code>vignettes/promises_04_mirai.Rmd</code></a></small>
      <div class="d-none name"><code>promises_04_mirai.Rmd</code></div>
    </div>

    
    
<style type="text/css">
.alert-secondary a, .alert-secondary a:visited {
  color: inherit;
  text-decoration: underline;
}
.alert code {
  color: inherit;
  background-color: inherit;
}
</style>
<p>We’ve updated this guide to using the <code>mirai</code> package from
<code>future</code> as we believe the following benefits are compelling
in the context of Shiny apps:</p>
<ol style="list-style-type: decimal">
<li>Faster startup times and much less per-task overhead, meaning you
can boost performance by making even shorter tasks async.</li>
<li>More linear scaling, meaning you get the same relative benefits
whether running 2 or 200 cores.</li>
<li>Event-driven promises using <code>mirai</code> vs. promises using
<code>future</code> which time-poll every 100 ms. Lower latency and
response times can help with the user experience.</li>
</ol>
<p>The previous guide using <code>future</code> is available <a href="promises_05a_futures.html">here</a>. Using <code>future</code>
continues to be supported within the Shiny ecosystem, and Henrik
Bengtsson‘s excellent work on the futureverse deserves credit for
pushing the boundaries of parallelism in R farther than many thought
possible.</p>
<hr>
<p>The <code>mirai</code> package provides a lightweight way to launch R
tasks that don’t block the current R session.</p>
<p>The <code>promises</code> package provides the API for working with
the results of async tasks, but it totally abdicates responsibility for
actually launching/creating async tasks. The idea is that any number of
different packages could be capable of launching async tasks, using
whatever techniques they want, but all of them would either return
promise objects or objects that can be converted to promise objects, as
is the case for <code>mirai</code>.</p>
<p>This document will give an introduction to the parts of
<code>mirai</code> that are most relevant to promises. For more
information, please consult the documentation and vignettes that come
with <a href="https://mirai.r-lib.org" class="external-link"><code>mirai</code></a>.</p>
<div class="section level2">
<h2 id="how-mirai-works">How mirai works<a class="anchor" aria-label="anchor" href="#how-mirai-works"></a>
</h2>
<p>The main API that <code>mirai</code> provides couldn’t be simpler.
You call <code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai()</a></code> and pass it the code that you want
executed asynchronously:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># expensive operations go here...</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">download_lots_of_data</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">fit_model</span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>The object that’s returned is a mirai, which for all intents and
purposes is a promise object<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;(The &lt;code&gt;mirai&lt;/code&gt; package provides several
functions for working with mirai objects, but they are not relevant for
our purposes.)&lt;/p&gt;"><sup>1</sup></a>, which will eventually resolve to the
return value of the code block (i.e. the last expression) or an error if
the code does not complete executing successfully. The important thing
is that no matter how long the expensive operation takes, these lines
will execute almost instantly, while the operation continues in the
background.</p>
<p>But we know that R is single-threaded, so how does <code>mirai</code>
accomplish this? The answer: by utilizing another R process.
<code>mirai</code> delegates the execution of the expensive operation to
a totally different R process, so that the original R process can move
on.</p>
</div>
<div class="section level2">
<h2 id="choosing-a-launch-method">Choosing a launch method<a class="anchor" aria-label="anchor" href="#choosing-a-launch-method"></a>
</h2>
<p>In mirai, the <code><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons()</a></code> function is used to set and
launch background R processes (<em>daemons</em>).</p>
<p>These background processes will be used/recycled for the life of the
originating R process. If a mirai is launched while all the background R
processes are busy executing, then the new mirai is queued until one of
the background processes frees up.</p>
<p>To launch <code>n</code> processes locally, you just need to call
<code>daemons(n)</code>, supplying the value of <code>n</code>.</p>
<p>You need to determine <code>n</code> yourself, and typically this
should be at most one less than the number of processor cores on your
machine, to leave one for the main R process. The reason we don’t
automatically detect this for you is that you may also be running other
tasks on your machine, and you should take this into account when
supplying a value for <code>n</code>.</p>
<p><code><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons()</a></code> has further arguments <code>url</code> and
<code>remote</code> for setting and launching remote daemons over the
network for distributed computing. To learn more, see the <a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link"><code>mirai::daemons()</code>
reference docs</a> as well as the daemons sections of the <a href="https://mirai.r-lib.org/articles/mirai.html" class="external-link"><code>mirai</code>
reference vignette</a>.</p>
<p>If you don’t set <code><a href="https://mirai.r-lib.org/reference/daemons.html" class="external-link">daemons()</a></code> in a session, then each
<code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai()</a></code> call will launch a new local R process solely for
the purpose of performing that evaluation. Whilst this may be desirable
in certain circumstances, this is rarely going to be the case for Shiny.
This is as we cannot limit the total number of processes spawned at any
one time. If a Shiny app has many simultaneous users, then this could
lead to an excessive number of processes being created, overwhelming the
system.</p>
</div>
<div class="section level2">
<h2 id="caveats-and-limitations">Caveats and limitations<a class="anchor" aria-label="anchor" href="#caveats-and-limitations"></a>
</h2>
<p>The abstractions that <code>mirai</code> presents are simple and
consistent, although it may take some time to get used to them. Please
read this entire section carefully before proceeding.</p>
<div class="section level3">
<h3 id="globals-providing-input-to-mirai-code-chunks">Globals: Providing input to mirai code chunks<a class="anchor" aria-label="anchor" href="#globals-providing-input-to-mirai-code-chunks"></a>
</h3>
<p>Most mirai code chunks will need to reference data from the original
process, e.g. data to be fitted, URLs to be requested, file paths to
read from.</p>
<p>As evaluation happens in another process, these won’t be available to
the code chunk by default. These objects will need to be passed to the
<code>...</code> argument of your <code><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai()</a></code> call. These are
then serialized and sent to the other process along with the code to be
executed.</p>
<p>These objects include any functions which are defined in your session
and not in a package.</p>
<p>For example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">download_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">url</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">file</span>, <span class="st">"libcurl"</span><span class="op">)</span></span>
<span>  <span class="va">file</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"http://example.com/data.csv"</span></span>
<span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">download_data</span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  download_data <span class="op">=</span> <span class="va">download_data</span>,</span>
<span>  url <span class="op">=</span> <span class="va">url</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If there are many variables to pass through, mirai does offer a
convenience feature to pass an environment instead of individual
<code>...</code> pairs. The above call would then look like this
instead:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mirai.r-lib.org/reference/mirai.html" class="external-link">mirai</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">download_data</span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This passes the calling environment, which includes both the
<code>download_data</code> function as well as <code>url</code>.</p>
<p>Care should be taken when using this feature as it will also pass
anything else that happens to be in the same environment. It is safer to
use when mirai is called inside of another function, then
<code><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment()</a></code> will only consist of variables passed as
arguments to that function, or created locally within it.</p>
</div>
<div class="section level3">
<h3 id="package-loading">Package loading<a class="anchor" aria-label="anchor" href="#package-loading"></a>
</h3>
<p>Besides variables, package functions need to be declared with the
full namespace so that they can be found in the other process. For
example, using <code>dplyr::mutate()</code> instead of just
<code>mutate()</code>, even if the <code>dplyr</code> package is loaded
in your main session, as the other process will not have any packages
loaded by default.</p>
<p>Alternatively, make a call to load the package inside your mirai code
chunk, for example by adding <code><a href="https://dplyr.tidyverse.org" class="external-link">library(dplyr)</a></code>. Sometimes this
may be the most convenient option, especially for for infix operators.
For example the magrittr pipe <code>%&gt;%</code>, requires a
<code><a href="https://magrittr.tidyverse.org" class="external-link">library(magrittr)</a></code> to load the package beforehand.</p>
</div>
<div class="section level3">
<h3 id="custom-data-types">Custom Data Types<a class="anchor" aria-label="anchor" href="#custom-data-types"></a>
</h3>
<p>Certain objects are implemented at a low level, not using one of R’s
native vector types, and represented in R by an external pointer. An
example of this is an Arrow table. It is not possible to serialize these
to and from R’s native rds format. Instead they provide their own
serialization and deserialization methods.</p>
<p>mirai offers a seamless solution for working with these data types,
integrating those custom serialization and deserialization methods with
R’s native serialization so that you don’t need to manually handle each
instance of these objects when moving them across processes.</p>
<p>This does require a one-off configuration step when you set up
daemons, and you may read more about this in the <a href="https://mirai.r-lib.org/articles/mirai-serialization.html" class="external-link"><code>mirai</code>
serialization vignette</a>.</p>
</div>
<div class="section level3">
<h3 id="native-resources">Native resources<a class="anchor" aria-label="anchor" href="#native-resources"></a>
</h3>
<p>Mirai code blocks cannot use resources such as database connections
and network sockets that were created in the parent process. Even if it
seems to work with a simple test, you are asking for crashes or worse by
sharing these kinds of resources across processes.</p>
<p>Instead, make sure you create, use, and destroy such resources
entirely within the scope of the mirai code block.</p>
</div>
<div class="section level3">
<h3 id="mutation">Mutation<a class="anchor" aria-label="anchor" href="#mutation"></a>
</h3>
<p>Reference class objects (including R6 objects, S7 objects, and
data.table objects) and environments are among the few “native” R object
types that are mutable, that is, can be modified in-place. Unless they
contain native resources (see previous section), there’s nothing wrong
with using mutable objects from within mirai code blocks, even objects
created in the parent process. However, note that any changes you make
to these objects will not be visible from the parent process; the mirai
code is operating on a copy of the object, not the original.</p>
</div>
<div class="section level3">
<h3 id="returning-values">Returning values<a class="anchor" aria-label="anchor" href="#returning-values"></a>
</h3>
<p>Mirai code blocks return a value—they’d be a lot less useful if they
couldn’t! Like everywhere else in R, the return value is determined by
the last expression in the code block, unless <code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code> is
explicitly called earlier.</p>
<p>The return value will always be copied back into the parent process.
This matters for two reasons.</p>
<p>First, if the return value is very large, the copying process can
take some time — and because the data must essentially be serialized to
and deserialized from rds format, it can take a surprising amount of
time. In the case of mirai blocks that execute fairly quickly but return
huge amounts of data, you may be better off not using async techniques
at all.</p>
<p>Second, objects that refer to native resources are unlikely to work
in this direction either; just as you can’t use the parent’s database
connections in the child process, you also cannot have the child process
return a database connection for the parent to use.</p>
<div style="font-size: 20px; margin-top: 40px; text-align: right;">
<p>Next: <a href="promises_06_shiny.html">Using <code>promises</code>
with Shiny</a></p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Joe Cheng, <a href="http://schloerke.com" class="external-link">Barret Schloerke</a>, <a href="https://github.com/wch" class="external-link">Winston Chang</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer>
</body>
</html>
